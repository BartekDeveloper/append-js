<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript DOM Manipulation - Lekcja</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Custom Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-12);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-cyan);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-blue);
            box-shadow: 0 0 10px var(--accent-08);
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: #06B6D4 rgba(6, 182, 212, 0.1);
        }

        /* Light theme scrollbar */
        body.light-theme ::-webkit-scrollbar-track {
            background: rgba(6, 182, 212, 0.05);
        }

        body.light-theme ::-webkit-scrollbar-thumb {
            background: #0EA5E9;
        }

        body.light-theme ::-webkit-scrollbar-thumb:hover {
            background: #06B6D4;
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.6);
        }

        body.light-theme * {
            scrollbar-color: var(--secondary-blue) var(--primary-04);
        }

        :root {
            /* Base hues (H S L) */
            --h-primary: 187; /* cyan-ish */
            --s-primary: 85%;
            --l-primary: 49%;

            --h-secondary: 200; /* blue */
            --s-secondary: 90%;
            --l-secondary: 55%;

            --h-accent: 203; /* lighter cyan */
            --s-accent: 95%;
            --l-accent: 60%;

            --h-success: 150;
            --s-success: 60%;
            --l-success: 45%;

            --h-error: 354;
            --s-error: 78%;
            --l-error: 55%;

            --h-warning: 38;
            --s-warning: 90%;
            --l-warning: 50%;

            --bg-dark: hsl(215 28% 8%);
            --bg-darker: hsl(230 34% 4%);
            --bg-mid: hsl(220 18% 14%);

            /* Panel/card backgrounds and shadows */
            --panel-bg: hsla(220 16% 8% / 0.55);
            --card-bg: hsla(220 16% 8% / 0.5);
            --shadow-dark: hsla(220 12% 0% / 0.45);

            /* Convenience alpha variants for primary/accent */
            --primary-04: hsla(var(--h-primary) var(--s-primary) var(--l-primary) / 0.04);
            --primary-06: hsla(var(--h-primary) var(--s-primary) var(--l-primary) / 0.06);
            --primary-08: hsla(var(--h-primary) var(--s-primary) var(--l-primary) / 0.08);
            --primary-12: hsla(var(--h-primary) var(--s-primary) var(--l-primary) / 0.12);
            --accent-08: hsla(var(--h-accent) var(--s-accent) var(--l-accent) / 0.08);

            --primary-cyan: hsl(var(--h-primary) var(--s-primary) var(--l-primary));
            --secondary-blue: hsl(var(--h-secondary) var(--s-secondary) var(--l-secondary));
            --accent-cyan: hsl(var(--h-accent) var(--s-accent) var(--l-accent));
            --dark-accent: hsl(200 60% 20%);

            --text-primary: hsl(220 20% 96%);
            --text-secondary: hsl(210 16% 78%);

            --success: hsl(var(--h-success) var(--s-success) var(--l-success));
            --error: hsl(var(--h-error) var(--s-error) var(--l-error));
            --warning: hsl(var(--h-warning) var(--s-warning) var(--l-warning));
        }

        /* Light theme overrides tuned for high contrast (AAA target) */
        body.light-theme {
            --bg-dark: hsl(210 24% 98%);
            --bg-darker: hsl(210 20% 96%);
            --bg-mid: hsl(210 18% 92%);

            --card-bg: hsla(210 18% 98% / 0.98);
            --panel-bg: hsla(210 16% 96% / 0.96);
            --shadow-dark: hsla(210 10% 0% / 0.12);

            --text-primary: hsl(210 12% 8%);
            --text-secondary: hsl(210 8% 40%);

            /* Make success/error more vibrant in light mode */
            --h-success: 140; --s-success: 70%; --l-success: 35%;
            --h-error: 355; --s-error: 85%; --l-error: 45%;

            --primary-cyan: hsl(var(--h-primary) var(--s-primary) 44%);
            --secondary-blue: hsl(var(--h-secondary) var(--s-secondary) 48%);
            --accent-cyan: hsl(var(--h-accent) var(--s-accent) 60%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 50%, var(--bg-mid) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            position: relative;
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-cyan), var(--secondary-blue), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 40px rgba(6, 182, 212, 0.5);
            filter: drop-shadow(0 0 20px rgba(6, 182, 212, 0.6));
        }

        .subtitle {
            font-size: clamp(1rem, 2.5vw, 1.5rem);
            color: var(--text-secondary);
            margin-bottom: 30px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        body.light-theme .subtitle {
            color: #1F2937;
            text-shadow: none;
        }

        .timer-container {
            display: none;
        }

        .timer {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--panel-bg);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--primary-12);
            box-shadow: inset 0 2px 10px var(--shadow-dark);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-cyan), var(--secondary-blue), var(--accent-cyan));
            transition: width 0.3s ease;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.8);
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 15px 30px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary-12);
            border-radius: 15px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .tab:hover {
            background: hsla(220 20% 14% / 0.65);
            border-color: var(--primary-cyan);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--primary-06);
        }

        .tab.active {
            background: rgba(6, 182, 212, 0.2);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.6),
                        inset 0 0 20px rgba(6, 182, 212, 0.2);
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.8);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 2px solid var(--primary-12);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px var(--shadow-dark),
                        0 0 20px var(--primary-06);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-cyan);
            box-shadow: 0 15px 50px var(--shadow-dark),
                        0 0 40px var(--primary-06);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-cyan);
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.6);
        }

        .dom-tree {
            font-family: 'Courier New', monospace;
            background: hsla(220 12% 6% / 0.5);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid var(--primary-12);
            overflow-x: auto;
            box-shadow: inset 0 0 20px var(--shadow-dark);
        }

        .tree-node {
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 5px;
            border-radius: 5px;
        }

        .tree-node:hover {
            background: var(--primary-12);
            text-shadow: 0 0 10px var(--primary-06);
        }

        .tree-node.element {
            color: var(--primary-cyan);
        }

        .tree-node.collapsed .children {
            display: none;
        }

        .tree-toggle {
            display: inline-block;
            width: 20px;
            color: var(--accent-cyan);
            font-weight: bold;
        }

        .review-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .question-card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border: 2px solid var(--primary-12);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .question-card:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px var(--primary-06);
        }

        .question-title {
            font-weight: bold;
            color: var(--accent-cyan);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .answer {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-top: 10px;
            padding: 10px;
            background: hsla(220 12% 6% / 0.5);
            border-radius: 10px;
            border-left: 3px solid var(--primary-cyan);
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .definitions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        @media (max-width: 768px) {
            .definitions-grid {
                grid-template-columns: 1fr;
            }
        }

        .method-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 2px solid var(--primary-12);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .method-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--primary-12) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .method-card:hover::before {
            opacity: 1;
        }

        .method-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--accent-cyan);
            box-shadow: 0 20px 60px var(--shadow-dark),
                        0 0 50px var(--primary-06);
        }

        .method-signature {
            font-family: 'Courier New', monospace;
            background: hsla(220 12% 8% / 0.6);
            padding: 15px;
            border-radius: 10px;
            color: var(--accent-cyan);
            margin-bottom: 15px;
            border: 1px solid var(--primary-12);
            font-size: 1rem;
            overflow-x: auto;
            text-shadow: 0 0 5px var(--accent-08);
        }

        .method-definition {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.6;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .code-example {
            font-family: 'Courier New', monospace;
            background: hsla(220 12% 6% / 0.6);
            padding: 15px;
            border-radius: 10px;
            color: hsl(140 60% 50%);
            border: 2px solid var(--primary-12);
            margin-top: 10px;
            overflow-x: auto;
            box-shadow: inset 0 0 20px var(--shadow-dark);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .code-example pre {
            margin: 0;
            background: transparent;
            border: none;
            padding: 0;
        }

        .code-example code {
            background: transparent;
            padding: 0;
        }

        .code-highlight-preview {
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            background: hsla(220 12% 6% / 0.6);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--primary-12);
            overflow-x: auto;
            min-height: 50px;
        }

        .code-highlight-preview pre {
            margin: 0;
            background: transparent;
        }

        .code-highlight-preview code {
            background: transparent;
            padding: 0;
        }

        .mdn-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-cyan));
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-top: 10px;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.5);
            position: relative;
            z-index: 500;
        }

        .exercise-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .difficulty-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .difficulty-easy {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid var(--success);
            color: var(--success);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        .difficulty-medium {
            background: rgba(245, 158, 11, 0.2);
            border: 2px solid var(--warning);
            color: var(--warning);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
        }

        .difficulty-hard {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--error);
            color: var(--error);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }

        .task-description {
            color: var(--text-primary);
            margin-bottom: 15px;
            line-height: 1.6;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .code-editor-container {
            position: relative;
            width: 100%;
            min-height: 200px;
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(6, 182, 212, 0.4);
        }

        .monaco-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            color: var(--accent-cyan);
            gap: 15px;
        }

        .monaco-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(6, 182, 212, 0.2);
            border-top: 4px solid var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Monaco editor will replace textarea */
        .monaco-editor-wrapper {
            width: 100%;
            height: 100%;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, var(--primary-cyan), var(--secondary-blue));
            border: 2px solid var(--accent-cyan);
            border-radius: 10px;
            color: var(--text-primary);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            box-shadow: 0 5px 20px rgba(6, 182, 212, 0.4);
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(6, 182, 212, 0.6);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .solution {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success);
            border-radius: 10px;
            border-left: 5px solid var(--success);
        }

        .solution.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }

        .solution-title {
            color: var(--success);
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
        }

        .quiz-question {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .quiz-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            background: linear-gradient(135deg, var(--primary-cyan), var(--secondary-blue));
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
        }

        .question-points {
            color: var(--warning);
            font-weight: bold;
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.6);
        }

        .question-text {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 20px;
            line-height: 1.6;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .options {
            display: grid;
            gap: 15px;
        }

        .option {
              padding: 15px 20px;
              background: rgba(255, 255, 255, 0.04);
              backdrop-filter: blur(8px);
              border: 2px solid rgba(6, 182, 212, 0.18);
              border-radius: 12px;
              cursor: pointer;
              transition: background-color 180ms ease, box-shadow 180ms ease, transform 180ms ease, border-color 180ms ease;
              color: var(--text-primary);
              font-size: 1rem;
              position: relative;
              overflow: visible;
        }

        /* Subtle, light highlight on hover */
        .option:hover {
              background: rgba(6, 182, 212, 0.04);
              border-color: rgba(6, 182, 212, 0.28);
              transform: translateY(-3px);
              box-shadow: 0 8px 20px rgba(6, 182, 212, 0.06);
        }

        /* Stronger visible selected state */
        .option.selected {
              background: linear-gradient(90deg, rgba(6,182,212,0.18), rgba(56,189,248,0.12));
              border-color: rgba(56,189,248,0.9);
              box-shadow: 0 10px 30px rgba(6, 182, 212, 0.28);
              transform: translateY(-2px);
              color: var(--text-primary);
              z-index: 2;
        }

        /* Add a checkmark indicator on selected answers */
        .option.selected::after {
            content: 'âœ“';
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.12);
            color: #ffffff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .option.correct {
              background: linear-gradient(90deg, rgba(16,185,129,0.14), rgba(16,185,129,0.08));
              border-color: var(--success);
              box-shadow: 0 6px 30px rgba(16, 185, 129, 0.18);
              color: var(--success);
        }

        .option.incorrect {
              background: linear-gradient(90deg, rgba(239,68,68,0.12), rgba(239,68,68,0.06));
              border-color: var(--error);
              box-shadow: 0 6px 30px rgba(239, 68, 68, 0.16);
              color: var(--error);
        }

        .explanation {
            margin-top: 12px;
            padding: 12px 14px;
            background: rgba(0,0,0,0.35);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .explanation strong {
            color: var(--accent-cyan);
        }

        .score-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(6, 182, 212, 0.4);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3),
                        0 0 30px rgba(6, 182, 212, 0.3);
        }

        .score-display {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-cyan), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(6, 182, 212, 0.6);
            margin-bottom: 10px;
        }

        .score-label {
            color: var(--text-secondary);
            font-size: 1.2rem;
        }

        .results-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(6, 182, 212, 0.4);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-top: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4),
                        0 0 50px rgba(6, 182, 212, 0.5);
        }

        .grade-display {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .grade-excellent {
            color: #10B981;
            text-shadow: 0 0 40px rgba(16, 185, 129, 0.8);
        }

        .grade-good {
            color: #3B82F6;
            text-shadow: 0 0 40px rgba(59, 130, 246, 0.8);
        }

        .grade-fair {
            color: #F59E0B;
            text-shadow: 0 0 40px rgba(245, 158, 11, 0.8);
        }

        .grade-poor {
            color: #EF4444;
            text-shadow: 0 0 40px rgba(239, 68, 68, 0.8);
        }

        .feedback-message {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-top: 20px;
            line-height: 1.6;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--primary-cyan);
            position: fixed;
            animation: confettiFall 3s linear forwards;
            pointer-events: none;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                padding: 20px 10px;
            }

            .nav-tabs {
                gap: 5px;
            }

            .tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .definitions-grid {
                grid-template-columns: 1fr;
            }

            .timer {
                font-size: 1.5rem;
            }
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(6, 182, 212, 0.4);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 8px 30px rgba(6, 182, 212, 0.5);
            border-color: var(--accent-cyan);
        }

        .theme-toggle:active {
            transform: scale(0.95) rotate(-15deg);
        }

        body.light-theme {
            background: linear-gradient(135deg, #FFFFFF 0%, #FFFFFF 50%, #F8FAFC 100%);
            color: #000000;
        }

        body.light-theme .card,
        body.light-theme .method-card,
        body.light-theme .exercise-card,
        body.light-theme .quiz-question,
        body.light-theme .score-card,
        body.light-theme .results-card,
        body.light-theme .question-card {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(6, 182, 212, 0.4);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .tab {
            background: rgba(6, 182, 212, 0.1);
            border-color: rgba(6, 182, 212, 0.4);
            color: #1F2937;
        }

        body.light-theme .tab.active {
            background: rgba(6, 182, 212, 0.3);
            border-color: #0891B2;
            color: #000000;
        }

        body.light-theme .card-title,
        body.light-theme .question-title {
            color: #0891B2;
        }

        body.light-theme .text-primary,
        body.light-theme .task-description,
        body.light-theme .question-text {
            color: #000000;
        }

        body.light-theme .text-secondary,
        body.light-theme .answer,
        body.light-theme .method-definition {
            color: #1F2937;
        }

        body.light-theme .dom-tree,
        body.light-theme .code-editor,
        body.light-theme .code-example,
        body.light-theme .test-area,
        body.light-theme .code-highlight-preview,
        body.light-theme .output-panel {
            background: rgba(15, 23, 42, 0.05);
            border-color: rgba(6, 182, 212, 0.3);
        }

        body.light-theme .method-signature {
            background: rgba(15, 23, 42, 0.08);
            color: #0891B2;
        }

        body.light-theme .tree-node.element {
            color: #0891B2;
        }

        body.light-theme .option {
            background: rgba(6, 182, 212, 0.03);
            border-color: rgba(6, 182, 212, 0.18);
            color: #0b1220;
        }

        body.light-theme .option:hover {
            background: rgba(6, 182, 212, 0.06);
            border-color: rgba(6, 182, 212, 0.32);
            box-shadow: 0 8px 18px rgba(6, 182, 212, 0.06);
        }

        body.light-theme .option.selected::after {
            background: rgba(255,255,255,0.95);
            color: #0891B2;
        }

        body.light-theme .theme-toggle {
            background: rgba(6, 182, 212, 0.15);
            border-color: rgba(6, 182, 212, 0.4);
        }

        body.light-theme .btn {
            color: #000000;
        }

        body.light-theme .score-label {
            color: #1F2937;
        }

        body.light-theme .test-area-label,
        body.light-theme .output-label {
            color: #1F2937;
        }

        body.light-theme .difficulty-badge {
            color: #000000;
        }

        body.light-theme .tree-toggle {
            color: #0891B2;
        }

        body.light-theme h1 {
            background: linear-gradient(135deg, #0891B2, #0284C7, #06B6D4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.light-theme .feedback-message {
            color: #000000;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(6, 182, 212, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px 25px;
            border-radius: 12px;
            border: 2px solid var(--accent-cyan);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5),
                        0 0 30px rgba(6, 182, 212, 0.6);
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .test-area {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px dashed rgba(6, 182, 212, 0.4);
            border-radius: 10px;
            min-height: 100px;
        }

        .test-area-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .output-panel {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(6, 182, 212, 0.4);
            border-radius: 10px;
            min-height: 80px;
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
            display: none;
        }

        .output-panel.visible {
            display: block;
        }

        .output-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .output-content {
            color: #4ade80;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .output-error {
            color: var(--error);
        }

        .validation-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .validation-correct {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid var(--success);
            color: var(--success);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
        }

        .validation-incorrect {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--error);
            color: var(--error);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
        }

        .validation-icon {
            font-size: 1.5rem;
        }

        .btn-run {
            margin-right: 10px;
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .btn-run:hover {
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.6);
        }

        .exercise-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .mdn-link {
            color: var(--accent-cyan);
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .mdn-link:hover {
            color: var(--primary-cyan);
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.8);
        }

        .mdn-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--secondary-blue), var(--primary-cyan));
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            margin-top: 10px;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mdn-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(6, 182, 212, 0.7);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>JavaScript DOM Manipulation</h1>
            <p class="subtitle">appendChild i metody pokrewne</p>
            <button class="theme-toggle" id="themeToggle" title="ZmieÅ„ motyw">
                <span class="theme-icon">ðŸŒ™</span>
            </button>
        </header>

        <div class="nav-tabs">
            <button class="tab active" data-section="review">PowtÃ³rka</button>
            <button class="tab" data-section="definitions">Definicje</button>
            <button class="tab" data-section="exercises">Ä†wiczenia</button>
            <button class="tab" data-section="quiz">KartkÃ³wka</button>
        </div>

        <section id="review" class="section active">
            <div class="card">
                <h2 class="card-title">Drzewo DOM</h2>
                <div class="dom-tree" id="domTree"></div>
            </div>

            <div class="review-grid" id="reviewQuestions"></div>
        </section>

        <section id="definitions" class="section">
            <div class="definitions-grid" id="definitionsGrid"></div>
        </section>

        <section id="exercises" class="section">
            <div id="exercisesContainer"></div>
        </section>

        <section id="quiz" class="section">
            <div class="score-card">
                <div class="score-display" id="scoreDisplay">0 / 20</div>
                <div class="score-label">Punkty (<span id="scorePercent">0</span>%)</div>
            </div>
            <div id="quizContainer"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" id="submitQuiz">SprawdÅº odpowiedzi</button>
            </div>
            <div id="resultsContainer"></div>
        </section>
    </div>

    <script>
        // Monaco Editor state
        let monacoLoaded = false;
        let monacoEditors = {};
        const editorContents = {};

        // Storage keys
        const STORAGE_KEY_TAB = 'domLesson_activeTab';
        const STORAGE_KEY_THEME = 'domLesson_theme'; // 'light' or 'dark'

        // In-memory fallback (used only if localStorage is unavailable)
        let activeTabMemory = 'review';

        function saveActiveTab(sectionId) {
            try {
                localStorage.setItem(STORAGE_KEY_TAB, sectionId);
            } catch (e) {
                // localStorage may be unavailable (privacy mode, etc.)
                activeTabMemory = sectionId;
            }
        }

        function loadActiveTab() {
            try {
                return localStorage.getItem(STORAGE_KEY_TAB) || activeTabMemory;
            } catch (e) {
                return activeTabMemory;
            }
        }

        function saveTheme(isLight) {
            try {
                localStorage.setItem(STORAGE_KEY_THEME, isLight ? 'light' : 'dark');
            } catch (e) {
                // ignore
            }
        }

        function loadTheme() {
            try {
                return localStorage.getItem(STORAGE_KEY_THEME);
            } catch (e) {
                return null;
            }
        }

        // Initialize highlight.js
        document.addEventListener('DOMContentLoaded', function() {
            hljs.highlightAll();

            // Restore active tab from storage (persists across reloads)
            const savedTab = loadActiveTab();
            if (savedTab && savedTab !== 'review') {
                const tab = document.querySelector(`.tab[data-section="${savedTab}"]`);
                if (tab) {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const sectionEl = document.getElementById(savedTab);
                    if (sectionEl) sectionEl.classList.add('active');

                    // Lazy load Monaco editor if needed
                    if (savedTab === 'exercises') {
                        loadMonacoEditor().catch(() => {});
                    }
                }
            }

            // Apply saved theme if present
            const savedTheme = loadTheme();
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
            } else if (savedTheme === 'dark') {
                document.body.classList.remove('light-theme');
            }
        });

        // Tab navigation
        const tabs = document.querySelectorAll('.tab');
        const sections = document.querySelectorAll('.section');
        
        tabs.forEach((tab, index) => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                sections.forEach(s => s.classList.remove('active'));

                tab.classList.add('active');
                const sectionId = tab.getAttribute('data-section');
                const sectionEl = document.getElementById(sectionId);
                if (sectionEl) sectionEl.classList.add('active');

                // Save active tab to storage (with fallback)
                saveActiveTab(sectionId);

                // Re-highlight code when switching to definitions
                if (sectionId === 'definitions') {
                    setTimeout(() => hljs.highlightAll(), 500);
                }

                // Lazy load Monaco editor when exercises tab is clicked
                if (sectionId === 'exercises' && !monacoLoaded) {
                    loadMonacoEditor().catch(() => {});
                }
            });
        });

        // DOM Tree data
        const domTreeStructure = {
            name: 'document',
            children: [
                {
                    name: 'html',
                    children: [
                        {
                            name: 'head',
                            children: [
                                { name: 'title', children: [] },
                                { name: 'meta', children: [] }
                            ]
                        },
                        {
                            name: 'body',
                            children: [
                                { name: 'header', children: [] },
                                {
                                    name: 'main',
                                    children: [
                                        {
                                            name: 'section',
                                            children: [
                                                { name: 'h2', children: [] },
                                                {
                                                    name: 'div',
                                                    children: [
                                                        { name: 'p', children: [] },
                                                        { name: 'button', children: [] }
                                                    ]
                                                }
                                            ]
                                        },
                                        {
                                            name: 'ul',
                                            children: [
                                                { name: 'li', children: [] },
                                                { name: 'li', children: [] },
                                                { name: 'li', children: [] }
                                            ]
                                        }
                                    ]
                                },
                                { name: 'footer', children: [] }
                            ]
                        }
                    ]
                }
            ]
        };

        function renderTreeNode(node, level = 0) {
            const indent = '  '.repeat(level);
            const hasChildren = node.children && node.children.length > 0;
            const toggle = hasChildren ? '<span class="tree-toggle">â–¼</span>' : '<span class="tree-toggle"> </span>';
            
            let html = `<div class="tree-node element" style="padding-left: ${level * 20}px;" data-level="${level}">`;
            html += `${toggle}&lt;${node.name}&gt;`;
            html += '</div>';
            
            if (hasChildren) {
                html += '<div class="children">';
                node.children.forEach(child => {
                    html += renderTreeNode(child, level + 1);
                });
                html += '</div>';
            }
            
            return html;
        }

        document.getElementById('domTree').innerHTML = renderTreeNode(domTreeStructure);

        // Make tree nodes collapsible
        document.querySelectorAll('.tree-node').forEach(node => {
            node.addEventListener('click', (e) => {
                e.stopPropagation();
                const toggle = node.querySelector('.tree-toggle');
                const children = node.nextElementSibling;
                
                if (children && children.classList.contains('children')) {
                    if (children.style.display === 'none') {
                        children.style.display = 'block';
                        toggle.textContent = 'â–¼';
                    } else {
                        children.style.display = 'none';
                        toggle.textContent = 'â–¶';
                    }
                }
            });
        });

        // Review questions
        const reviewQuestions = [
            {
                question: 'Co to jest DOM?',
                answer: 'DOM (Document Object Model) to programowy interfejs dla dokumentÃ³w HTML i XML. Reprezentuje strukturÄ™ dokumentu jako drzewo obiektÃ³w, ktÃ³re moÅ¼na modyfikowaÄ‡ za pomocÄ… JavaScript.'
            },
            {
                question: 'Jaka jest rÃ³Å¼nica miÄ™dzy appendChild a insertBefore?',
                answer: 'appendChild dodaje element na koÅ„cu listy dzieci rodzica, podczas gdy insertBefore pozwala wstawiÄ‡ element przed konkretnym dzieckiem rodzica.'
            },
            {
                question: 'Co siÄ™ stanie, jeÅ›li uÅ¼yjesz appendChild na elemencie, ktÃ³ry juÅ¼ istnieje w DOM?',
                answer: 'Element zostanie przeniesiony z obecnej pozycji do nowej lokalizacji. appendChild automatycznie usuwa element z poprzedniego miejsca.'
            },
            {
                question: 'Jakie sÄ… dwa parametry metody insertBefore?',
                answer: 'Pierwszy parametr to nowy wÄ™zeÅ‚ do wstawienia, drugi to wÄ™zeÅ‚ referencyjny, przed ktÃ³rym zostanie wstawiony nowy element.'
            }
        ];

        const reviewContainer = document.getElementById('reviewQuestions');
        reviewQuestions.forEach(item => {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.innerHTML = `
                <div class="question-title">${item.question}</div>
                <div class="answer">${item.answer}</div>
            `;
            reviewContainer.appendChild(card);
        });

        // Definitions
        const definitions = [
            {
                method: 'document.createElement(tagName)',
                definition: 'Tworzy nowy element HTML o podanym typie tagu.',
                example: "const div = document.createElement('div');",
                mdnUrl: 'https://developer.mozilla.org/en-US/docs/Web/API/Document/createElement'
            },
            {
                method: 'parent.appendChild(child)',
                definition: 'Dodaje wÄ™zeÅ‚ jako ostatnie dziecko wÄ™zÅ‚a rodzica. JeÅ›li element juÅ¼ istnieje w DOM, zostanie przeniesiony.',
                example: 'parentElement.appendChild(newElement);',
                mdnUrl: 'https://developer.mozilla.org/en-US/docs/Web/API/Node/appendChild'
            },
            {
                method: 'parent.insertBefore(newNode, referenceNode)',
                definition: 'Wstawia nowy wÄ™zeÅ‚ przed wskazanym wÄ™zÅ‚em referencyjnym jako dziecko okreÅ›lonego rodzica.',
                example: 'parent.insertBefore(newElement, parent.firstChild);',
                mdnUrl: 'https://developer.mozilla.org/en-US/docs/Web/API/Node/insertBefore'
            },
            {
                method: 'parent.removeChild(child)',
                definition: 'Usuwa okreÅ›lony wÄ™zeÅ‚ dziecka z drzewa DOM i zwraca usuniÄ™ty wÄ™zeÅ‚.',
                example: 'parent.removeChild(childElement);',
                mdnUrl: 'https://developer.mozilla.org/en-US/docs/Web/API/Node/removeChild'
            },
            {
                method: 'parent.replaceChild(newChild, oldChild)',
                definition: 'ZastÄ™puje istniejÄ…cy wÄ™zeÅ‚ dziecka nowym wÄ™zÅ‚em.',
                example: 'parent.replaceChild(newElement, oldElement);',
                mdnUrl: 'https://developer.mozilla.org/en-US/docs/Web/API/Node/replaceChild'
            }
        ];

        const definitionsGrid = document.getElementById('definitionsGrid');
        definitions.forEach(def => {
            const card = document.createElement('div');
            card.className = 'method-card';
            card.innerHTML = `
                <div class="method-signature">${def.method}</div>
                <div class="method-definition">${def.definition}</div>
                <div class="code-example"><pre><code class="language-javascript">${def.example}</code></pre></div>
                <a href="${def.mdnUrl}" target="_blank" rel="noopener noreferrer" class="mdn-badge">MDN Docs â†’</a>
            `;
            definitionsGrid.appendChild(card);
        });
        
        // Highlight code in definitions
        setTimeout(() => hljs.highlightAll(), 500);

        // Exercises
        const exercises = [
            {
                level: 'Å‚atwy',
                task: "StwÃ³rz nowy element &lt;p&gt; z tekstem 'Hello World' i dodaj go do elementu o id='container'",
                solution: `const p = document.createElement('p');
p.textContent = 'Hello World';
document.getElementById('container').appendChild(p);`,
                validate: function(testArea) {
                    const p = testArea.querySelector('p');
                    return p && p.textContent.trim() === 'Hello World';
                }
            },
            {
                level: 'Å›redni',
                task: "StwÃ³rz listÄ™ &lt;ul&gt; z trzema elementami &lt;li&gt; zawierajÄ…cymi teksty: 'JabÅ‚ko', 'Gruszka', 'Banan'",
                solution: `const ul = document.createElement('ul');
const items = ['JabÅ‚ko', 'Gruszka', 'Banan'];
items.forEach(text => {
  const li = document.createElement('li');
  li.textContent = text;
  ul.appendChild(li);
});
document.body.appendChild(ul);`,
                validate: function(testArea) {
                    const ul = testArea.querySelector('ul');
                    if (!ul) return false;
                    const lis = ul.querySelectorAll('li');
                    if (lis.length !== 3) return false;
                    const texts = Array.from(lis).map(li => li.textContent.trim());
                    return texts.includes('JabÅ‚ko') && texts.includes('Gruszka') && texts.includes('Banan');
                }
            },
            {
                level: 'trudny',
                task: "Wstaw nowy element &lt;div&gt; przed pierwszym dzieckiem kontenera o id='main'",
                solution: `const div = document.createElement('div');
div.textContent = 'Pierwszy element';
const main = document.getElementById('main');
main.insertBefore(div, main.firstChild);`,
                validate: function(testArea) {
                    const main = testArea.querySelector('#main');
                    if (!main || !main.firstChild) return false;
                    return main.firstChild.tagName === 'DIV';
                }
            },
            {
                level: 'trudny',
                task: "ZastÄ…p drugi element listy &lt;ul id='myList'&gt; nowym elementem z tekstem 'Nowy element'",
                solution: `const ul = document.getElementById('myList');
const newLi = document.createElement('li');
newLi.textContent = 'Nowy element';
const secondChild = ul.children[1];
ul.replaceChild(newLi, secondChild);`,
                validate: function(testArea) {
                    const ul = testArea.querySelector('#myList');
                    if (!ul || ul.children.length < 2) return false;
                    return ul.children[1].textContent.includes('Nowy element');
                }
            }
        ];

        const exercisesContainer = document.getElementById('exercisesContainer');
        exercises.forEach((ex, idx) => {
            const difficultyClass = ex.level === 'Å‚atwy' ? 'difficulty-easy' : 
                                   ex.level === 'Å›redni' ? 'difficulty-medium' : 'difficulty-hard';
            
            // Setup initial test areas for exercises that need them
            let testAreaSetup = '';
            if (idx === 0) {
                testAreaSetup = '<div id="container"></div>';
            } else if (idx === 2) {
                testAreaSetup = '<div id="main"><p>IstniejÄ…cy element</p></div>';
            } else if (idx === 3) {
                testAreaSetup = '<ul id="myList"><li>Element 1</li><li>Element 2</li><li>Element 3</li></ul>';
            }
            
            const card = document.createElement('div');
            card.className = 'exercise-card';
            card.innerHTML = `
                <span class="difficulty-badge ${difficultyClass}">${ex.level}</span>
                <div class="task-description"><strong>Zadanie ${idx + 1}:</strong> ${ex.task}</div>
                <div class="code-editor-container" id="editorContainer${idx}">
                    <div class="monaco-loading">
                        <div class="monaco-spinner"></div>
                        <div>Åadowanie edytora...</div>
                    </div>
                </div>
                <div class="exercise-buttons">
                    <button class="btn btn-run" onclick="runCode(${idx})">â–¶ Uruchom kod</button>
                    <button class="btn" onclick="showSolution(${idx})">PokaÅ¼ rozwiÄ…zanie</button>
                </div>
                <div id="validationResult${idx}"></div>
                <div class="output-panel" id="output${idx}">
                    <div class="output-label">Wynik:</div>
                    <div class="output-content" id="outputContent${idx}"></div>
                </div>
                <div class="test-area-label">Obszar testowy:</div>
                <div class="test-area" id="testArea${idx}">${testAreaSetup}</div>
                <div class="solution" id="solution${idx}">
                    <div class="solution-title">RozwiÄ…zanie:</div>
                    <div class="code-example"><pre><code class="language-javascript">${ex.solution}</code></pre></div>
                </div>
            `;
            exercisesContainer.appendChild(card);
        });
        
        // Highlight code in exercises after DOM is ready
        setTimeout(() => hljs.highlightAll(), 100);

        function showSolution(idx) {
            const solution = document.getElementById(`solution${idx}`);
            solution.classList.toggle('visible');
            setTimeout(() => hljs.highlightAll(), 50);
        }
        
        function runCode(idx) {
            // Get code from Monaco editor or fallback
            let code = '';
            try {
                if (monacoEditors && monacoEditors[idx] && typeof monacoEditors[idx].getValue === 'function') {
                    code = monacoEditors[idx].getValue() || '';
                } else {
                    code = editorContents[idx] || document.getElementById(`fallbackEditor${idx}`)?.value || '';
                }
            } catch (e) {
                code = editorContents[idx] || document.getElementById(`fallbackEditor${idx}`)?.value || '';
            }
            
            const testArea = document.getElementById(`testArea${idx}`);
            const outputPanel = document.getElementById(`output${idx}`);
            const outputContent = document.getElementById(`outputContent${idx}`);
            const validationResult = document.getElementById(`validationResult${idx}`);
            
            // Validate panels exist
            if (!testArea || !outputPanel || !outputContent || !validationResult) {
                showToast('BÅ‚Ä…d: brak obszaru testowego lub panelu wyjÅ›cia.');
                return;
            }

            // Clear previous results
            outputContent.innerHTML = '';
            outputContent.classList.remove('output-error');
            validationResult.innerHTML = '';
            
            // Reset test area to initial state
            if (idx === 0) {
                testArea.innerHTML = '<div id="container"></div>';
            } else if (idx === 2) {
                testArea.innerHTML = '<div id="main"><p>IstniejÄ…cy element</p></div>';
            } else if (idx === 3) {
                testArea.innerHTML = '<ul id="myList"><li>Element 1</li><li>Element 2</li><li>Element 3</li></ul>';
            } else {
                testArea.innerHTML = '';
            }
            
            if (!code || !code.trim()) {
                outputContent.textContent = 'Brak kodu do uruchomienia.';
                outputContent.classList.add('output-error');
                outputPanel.classList.add('visible');
                return;
            }
            
            // Protect: avoid extremely large inputs
            if (code.length > 20000) {
                outputContent.textContent = 'Kod zbyt duÅ¼y do wykonania w przeglÄ…darce testowej.';
                outputContent.classList.add('output-error');
                outputPanel.classList.add('visible');
                return;
            }
            
            // Capture console logs
            const logs = [];
            const originalLog = console.log;
            let consoleRestored = false;
            console.log = function(...args) {
                try {
                    logs.push(args.map(arg => 
                        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                    ).join(' '));
                } catch (e) {
                    logs.push(String(args));
                }
                try { originalLog.apply(console, args); } catch (e) {}
            };

            try {
                // Create a safe execution context (scoped to testArea)
                const wrappedCode = `
                    (function() {
                        const testArea = document.getElementById('testArea${idx}');
                        const container = testArea ? testArea.querySelector('#container') : null;
                        const main = testArea ? testArea.querySelector('#main') : null;
                        const myList = testArea ? testArea.querySelector('#myList') : null;
                        
                        // Minimal safe overrides
                        const originalGetElementById = document.getElementById.bind(document);
                        document.getElementById = function(id) {
                            if (id === 'container' || id === 'main' || id === 'myList') {
                                return testArea ? testArea.querySelector('#' + id) : null;
                            }
                            return originalGetElementById(id);
                        };
                        
                        const originalBodyAppend = document.body.appendChild.bind(document.body);
                        document.body.appendChild = function(node) {
                            if (testArea) return testArea.appendChild(node);
                            return originalBodyAppend(node);
                        };
                        
                        try {
                            ${code}
                        } finally {
                            // restore
                            document.getElementById = originalGetElementById;
                            document.body.appendChild = originalBodyAppend;
                        }
                    })();
                `;
                
                // Evaluate user code in current context (still risky, but accepted for this dev environment)
                eval(wrappedCode);
            } catch (error) {
                // Ensure console restored
                try { console.log = originalLog; consoleRestored = true; } catch (e) {}

                outputContent.textContent = 'BÅ‚Ä…d: ' + (error && error.message ? error.message : String(error));
                outputContent.classList.add('output-error');
                outputPanel.classList.add('visible');

                validationResult.innerHTML = `
                    <div class="validation-indicator validation-incorrect">
                        <span class="validation-icon">âœ—</span>
                        <span>BÅ‚Ä…d w kodzie</span>
                    </div>
                `;

                // rethrow not necessary; we've shown the error
            } finally {
                if (!consoleRestored) {
                    try { console.log = originalLog; } catch (e) {}
                }

                // Show output (if not already shown by error path)
                if (!outputPanel.classList.contains('visible')) {
                    if (logs.length > 0) {
                        outputContent.textContent = logs.join('\n');
                    } else if (!outputContent.textContent || outputContent.textContent.trim() === '') {
                        outputContent.textContent = 'Kod wykonany pomyÅ›lnie (brak logÃ³w konsoli)';
                    }
                    outputPanel.classList.add('visible');

                    // Validate result (safe guard)
                    let isCorrect = false;
                    try {
                        isCorrect = !!exercises[idx].validate(testArea);
                    } catch (e) {
                        isCorrect = false;
                    }

                    if (isCorrect) {
                        validationResult.innerHTML = `
                            <div class="validation-indicator validation-correct">
                                <span class="validation-icon">âœ“</span>
                                <span>Poprawnie! Åšwietna robota!</span>
                            </div>
                        `;
                    } else {
                        validationResult.innerHTML = `
                            <div class="validation-indicator validation-incorrect">
                                <span class="validation-icon">âœ—</span>
                                <span>SprÃ³buj jeszcze raz</span>
                            </div>
                        `;
                    }
                }
            }
        }
        
        // Update highlight.js theme based on color scheme
        function updateHighlightTheme() {
            const isLight = document.body.classList.contains('light-theme');
            const oldLink = document.querySelector('link[href*="highlight.js"]');
            
            if (oldLink) {
                const newTheme = isLight ? 'atom-one-light' : 'atom-one-dark';
                const newLink = document.createElement('link');
                newLink.rel = 'stylesheet';
                newLink.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/${newTheme}.min.css`;
                
                oldLink.parentNode.insertBefore(newLink, oldLink.nextSibling);
                
                newLink.onload = function() {
                    oldLink.remove();
                    // Re-highlight all static code
                    hljs.highlightAll();
                };
            }
        }

        // Theme toggle functionality (setup after element is in DOM)
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = themeToggle ? themeToggle.querySelector('.theme-icon') : null;
        
        // Apply saved theme icon and Monaco theme on load
        (function applySavedThemeOnLoad() {
            const saved = loadTheme();
            if (!themeIcon || !themeToggle) return;
            if (saved === 'light') {
                document.body.classList.add('light-theme');
                themeIcon.textContent = 'â˜€ï¸';
            } else {
                document.body.classList.remove('light-theme');
                themeIcon.textContent = 'ðŸŒ™';
            }
            // Update highlight.js and Monaco theme to reflect stored choice
            updateHighlightTheme();
            updateMonacoTheme();
        })();

        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('light-theme');

                if (document.body.classList.contains('light-theme')) {
                    if (themeIcon) themeIcon.textContent = 'â˜€ï¸';
                    saveTheme(true);
                } else {
                    if (themeIcon) themeIcon.textContent = 'ðŸŒ™';
                    saveTheme(false);
                }

                // Update highlight.js theme
                updateHighlightTheme();

                // Update Monaco editor theme
                updateMonacoTheme();
            });
        }
        
        // Load Monaco Editor dynamically with timeout and fallback
        function loadMonacoEditor() {
            if (monacoLoaded) {
                return Promise.resolve();
            }

            return new Promise((resolve, reject) => {
                // small timeout fallback if loader never arrives
                let fallbackTimer = setTimeout(() => {
                    console.warn('Monaco load timed out, using fallback editors.');
                    createFallbackEditors();
                    reject(new Error('Monaco load timed out'));
                }, 15000);

                try {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs/loader.js';
                    script.onload = () => {
                        try {
                            require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@latest/min/vs' } });
                            require(['vs/editor/editor.main'], function() {
                                clearTimeout(fallbackTimer);
                                monacoLoaded = true;
                                initializeMonacoEditors();
                                resolve();
                            }, function(err) {
                                clearTimeout(fallbackTimer);
                                console.error('Monaco require failed:', err);
                                createFallbackEditors();
                                reject(err);
                            });
                        } catch (err) {
                            clearTimeout(fallbackTimer);
                            console.error('Error initializing Monaco:', err);
                            createFallbackEditors();
                            reject(err);
                        }
                    };
                    script.onerror = () => {
                        clearTimeout(fallbackTimer);
                        console.error('Failed to load Monaco Editor script');
                        createFallbackEditors();
                        reject(new Error('Failed to load Monaco Editor script'));
                    };
                    document.head.appendChild(script);
                } catch (err) {
                    clearTimeout(fallbackTimer);
                    console.error('Error while loading Monaco:', err);
                    createFallbackEditors();
                    reject(err);
                }
            });
        }
        
        function initializeMonacoEditors() {
            exercises.forEach((ex, idx) => {
                const container = document.getElementById(`editorContainer${idx}`);
                if (!container) return;
                
                container.innerHTML = '<div class="monaco-editor-wrapper" id="monacoEditor' + idx + '"></div>';
                
                const isDark = !document.body.classList.contains('light-theme');
                const theme = isDark ? 'vs-dark' : 'vs-light';
                
                try {
                    const editor = monaco.editor.create(document.getElementById(`monacoEditor${idx}`), {
                        value: editorContents[idx] || '',
                        language: 'javascript',
                        theme: theme,
                        wordWrap: 'on',
                        fontSize: 14,
                        lineHeight: 1.5,
                        fontFamily: 'Fira Code, Monaco, Courier New, monospace',
                        automaticLayout: true,
                        minimap: { enabled: false },
                        lineNumbers: 'on',
                        scrollBeyondLastLine: false,
                        tabSize: 2,
                        insertSpaces: true
                    });
                    
                    monacoEditors[idx] = editor;
                    
                    // Save content on change
                    editor.onDidChangeModelContent(() => {
                        editorContents[idx] = editor.getValue();
                    });
                } catch (error) {
                    console.error('Error creating Monaco editor:', error);
                    createFallbackEditor(idx, container);
                }
            });
        }
        
        function createFallbackEditors() {
            exercises.forEach((ex, idx) => {
                const container = document.getElementById(`editorContainer${idx}`);
                if (container) {
                    createFallbackEditor(idx, container);
                }
            });
        }
        
        function createFallbackEditor(idx, container) {
            container.innerHTML = `<textarea class="code-editor" id="fallbackEditor${idx}" placeholder="Wpisz tutaj swÃ³j kod..." spellcheck="false" style="width:100%;height:100%;background:rgba(0,0,0,0.5);color:var(--text-primary);border:none;padding:15px;font-family:'Courier New',monospace;font-size:14px;line-height:1.5;resize:none;">${editorContents[idx] || ''}</textarea>`;
            
            const editor = document.getElementById(`fallbackEditor${idx}`);
            editor.addEventListener('input', function() {
                editorContents[idx] = this.value;
            });
            
            // Store reference for runCode function
            monacoEditors[idx] = {
                getValue: () => editor.value
            };
        }
        
        // Update Monaco theme when app theme changes
        // Update Monaco theme when app theme changes
        function updateMonacoTheme() {
            try {
                if (!monacoLoaded || typeof monaco === 'undefined' || !window.monaco) return;

                const isDark = !document.body.classList.contains('light-theme');
                const theme = isDark ? 'vs-dark' : 'vs-light';

                monaco.editor.setTheme(theme);
            } catch (e) {
                console.warn('Failed to update monaco theme:', e);
            }
        }

        // Quiz
        const quizQuestions = [
            {
                id: 1,
                question: 'KtÃ³ra metoda tworzy nowy element HTML?',
                options: ['appendChild()', 'createElement()', 'createNode()', 'newElement()'],
                correct: 1,
                points: 1
                ,
                explanation: 'Metoda document.createElement(tagName) tworzy nowy element HTML o podanym tagu. appendChild nie tworzy elementu, tylko dodaje istniejÄ…cy.'
            },
            {
                id: 2,
                question: 'Co robi metoda appendChild()?',
                options: ['Usuwa element z DOM', 'Dodaje element jako ostatnie dziecko rodzica', 'Tworzy nowy element', 'ZastÄ™puje istniejÄ…cy element'],
                correct: 1,
                points: 1
                ,
                explanation: 'appendChild dodaje podany wÄ™zeÅ‚ jako ostatnie dziecko elementu rodzica. JeÅ›li wÄ™zeÅ‚ juÅ¼ istnieje, zostanie przeniesiony.'
            },
            {
                id: 3,
                question: 'Ile parametrÃ³w przyjmuje metoda insertBefore()?',
                options: ['1', '2', '3', '4'],
                correct: 1,
                points: 1
                ,
                explanation: 'insertBefore przyjmuje 2 parametry: nowy wÄ™zeÅ‚ i wÄ™zeÅ‚ referencyjny (przed ktÃ³rym zostanie wstawiony).'
            },
            {
                id: 4,
                question: 'KtÃ³ra metoda usuwa element z DOM?',
                options: ['deleteChild()', 'removeChild()', 'deleteElement()', 'remove()'],
                correct: 1,
                points: 1
                ,
                explanation: 'removeChild jest metodÄ… na rodzicu, ktÃ³ra usuwa wskazany wÄ™zeÅ‚ i zwraca go. Element.remove() jest wygodniejszÄ… metodÄ… wywoÅ‚ywanÄ… na samym elemencie.'
            },
            {
                id: 5,
                question: 'Co zwraca metoda removeChild()?',
                options: ['null', 'undefined', 'usuniÄ™ty wÄ™zeÅ‚', 'true/false'],
                correct: 2,
                points: 1
                ,
                explanation: 'removeChild zwraca usuniÄ™ty wÄ™zeÅ‚ (Node), co pozwala na jego dalsze uÅ¼ycie lub ponowne wstawienie.'
            },
            {
                id: 6,
                question: 'KtÃ³ra metoda zastÄ™puje istniejÄ…cy element nowym?',
                options: ['changeChild()', 'replaceChild()', 'swapChild()', 'updateChild()'],
                correct: 1,
                points: 1
            },
            {
                id: 7,
                question: 'Jaki parametr przyjmuje createElement()?',
                options: ['id elementu', 'klasÄ™ elementu', 'nazwÄ™ tagu', 'tekst elementu'],
                correct: 2,
                points: 1
            },
            {
                id: 8,
                question: 'Gdzie insertBefore wstawia nowy element?',
                options: ['Na koÅ„cu rodzica', 'Na poczÄ…tku rodzica', 'Przed wskazanym elementem referencyjnym', 'Po wskazanym elemencie referencyjnym'],
                correct: 2,
                points: 1
            },
            {
                id: 9,
                question: 'Co siÄ™ stanie, gdy appendChild zostanie uÅ¼yte na elemencie, ktÃ³ry juÅ¼ istnieje w DOM?',
                options: ['Zostanie utworzony duplikat', 'WystÄ…pi bÅ‚Ä…d', 'Element zostanie przeniesiony', 'Nic siÄ™ nie stanie'],
                correct: 2,
                points: 1
            },
            {
                id: 10,
                question: 'KtÃ³ra z poniÅ¼szych linijek kodu prawidÅ‚owo dodaje tekst do nowo utworzonego elementu?',
                options: ["element.text = 'Hello';", "element.textContent = 'Hello';", "element.addText('Hello');", "element.setText('Hello');"],
                correct: 1,
                points: 1
            },
            {
                id: 11,
                question: 'Jaka jest rola atrybutu \'id\' w DOM?',
                options: ['Ustawia styl elementu', 'Identyfikuje element za pomocÄ… selektora #id', 'Definiuje tekst elementu', 'OkreÅ›la rozmiar elementu'],
                correct: 1,
                points: 1
            },
            {
                id: 12,
                question: 'Czy appendChild zwraca wartoÅ›Ä‡?',
                options: ['Nie, zwraca null', 'Tak, zwraca dodany element', 'Tak, zwraca liczbÄ™ elementÃ³w', 'Nie, zwraca undefined'],
                correct: 1,
                points: 1
            },
            {
                id: 13,
                question: 'Jaki jest najprostszy sposÃ³b na usuniÄ™cie elementu z DOM?',
                options: ['element.delete()', 'element.remove()', 'deleteNode(element)', 'element.disappear()'],
                correct: 1,
                points: 1
            },
            {
                id: 14,
                question: 'Czy insertBefore wymaga wÄ™zÅ‚a referencyjnego?',
                options: ['Nie, jest opcjonalny', 'Tak, zawsze jest wymagany', 'Tylko jeÅ›li element istnieje', 'ZaleÅ¼y od przeglÄ…darki'],
                correct: 1,
                points: 1
            },
            {
                id: 15,
                question: 'Jaka wÅ‚aÅ›ciwoÅ›Ä‡ zwraca tekst elementu jako string?',
                options: ['element.text', 'element.content', 'element.textContent', 'element.getText()'],
                correct: 2,
                points: 1
            },
            {
                id: 16,
                question: 'Czy moÅ¼liwe jest skopiowanie elementu zamiast jego przenoszenia?',
                options: ['Nie, zawsze przenosi', 'Tak, za pomocÄ… cloneNode()', 'Tylko w przeglÄ…darce Chrome', 'Nie, JavaScript tego nie obsÅ‚uguje'],
                correct: 1,
                points: 1
            },
            {
                id: 17,
                question: 'Co zwraca metoda removeChild?',
                options: ['true jeÅ›li usuniÄ™to, false jeÅ›li nie', 'LiczbÄ™ pozostaÅ‚ych elementÃ³w', 'UsuniÄ™ty wÄ™zeÅ‚', 'null zawsze'],
                correct: 2,
                points: 1
            },
            {
                id: 18,
                question: 'Jaki jest rezultat replaceChild(nowy, stary)?',
                options: ['Stary element jest duplikowany', 'Stary element jest zamieniany na nowy', 'Oba elementy istniejÄ… obok siebie', 'Nowy element jest ignorowany'],
                correct: 1,
                points: 1
            },
            {
                id: 19,
                question: 'Czy firstChild zawsze zwraca element HTML?',
                options: ['Tak, zawsze', 'Nie, moÅ¼e zwrÃ³ciÄ‡ wÄ™zeÅ‚ tekstowy', 'Tylko jeÅ›li ma atrybuty', 'ZaleÅ¼y od przeglÄ…darki'],
                correct: 1,
                points: 1
            },
            {
                id: 20,
                question: 'KtÃ³ra metoda jest najnowsza i najprostsza do usuwania elementu?',
                options: ['parent.removeChild(element)', 'element.remove()', 'deleteElement(element)', 'element.delete()'],
                correct: 1,
                points: 1
            }
        ];

        const userAnswers = {};
        const quizContainer = document.getElementById('quizContainer');
        
        quizQuestions.forEach(q => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'quiz-question';
            
            let optionsHtml = '';
            q.options.forEach((option, idx) => {
                optionsHtml += `
                    <button class="option" data-question="${q.id}" data-answer="${idx}">
                        ${String.fromCharCode(65 + idx)}. ${option}
                    </button>
                `;
            });
            
            questionDiv.innerHTML = `
                <div class="quiz-question-header">
                    <span class="question-number">Pytanie ${q.id}</span>
                    <span class="question-points">${q.points} pkt</span>
                </div>
                <div class="question-text">${q.question}</div>
                <div class="options">${optionsHtml}</div>
            `;
            
            quizContainer.appendChild(questionDiv);
        });

        // Handle answer selection (do not update header score live; wait for submit)
        document.querySelectorAll('.option').forEach(btn => {
            btn.addEventListener('click', function() {
                const questionId = parseInt(this.getAttribute('data-question'));
                const answerIdx = parseInt(this.getAttribute('data-answer'));

                // Remove selection from other options
                document.querySelectorAll(`.option[data-question="${questionId}"]`).forEach(opt => {
                    opt.classList.remove('selected');
                });

                this.classList.add('selected');
                userAnswers[questionId] = answerIdx;

                // Do not call updateScore here â€” header score updates only after submit
            });
        });

        function updateScore() {
            let score = 0;
            quizQuestions.forEach(q => {
                if (userAnswers[q.id] === q.correct) {
                    score += q.points;
                }
            });
            
            const percentage = Math.round(Math.round((score / 20) * 100));
            document.getElementById('scoreDisplay').textContent = `${score} / 20`;
            document.getElementById('scorePercent').textContent = percentage;
        }

        // Submit quiz
        document.getElementById('submitQuiz').addEventListener('click', () => {
            let score = 0;
            
            quizQuestions.forEach(q => {
                const options = document.querySelectorAll(`.option[data-question="${q.id}"]`);
                const userAnswer = userAnswers[q.id];
                
                options.forEach((opt, idx) => {
                    if (idx === q.correct) {
                        opt.classList.add('correct');
                    } else if (idx === userAnswer && userAnswer !== q.correct) {
                        opt.classList.add('incorrect');
                    }
                    opt.style.pointerEvents = 'none';
                });
                
                if (userAnswer === q.correct) {
                    score += q.points;
                }

                // Add explanation block after the options
                try {
                    const questionEl = document.querySelector(`.quiz-question .options`).parentElement;
                    // Find the specific question container more reliably
                    const qContainer = document.querySelectorAll('.quiz-question')[quizQuestions.indexOf(q)];
                    if (qContainer) {
                        // remove existing explanation if any
                        const existing = qContainer.querySelector('.explanation');
                        if (existing) existing.remove();

                        const explanationText = q.explanation ? q.explanation : `Poprawna odpowiedÅº: ${q.options[q.correct]}`;
                        const expl = document.createElement('div');
                        expl.className = 'explanation';
                        expl.innerHTML = `<strong>WyjaÅ›nienie:</strong> ${explanationText}`;
                        qContainer.appendChild(expl);
                    }
                } catch (e) {
                    // ignore explanation render errors
                    console.warn('Could not render explanation for question', q.id, e);
                }
            });
            
            const percentage = Math.round((score / 20) * 100);
            // Update header score/percentage now that user submitted
            document.getElementById('scoreDisplay').textContent = `${score} / 20`;
            document.getElementById('scorePercent').textContent = percentage;

            showResults(score, percentage);
            
            document.getElementById('submitQuiz').disabled = true;
            document.getElementById('submitQuiz').style.opacity = '0.5';
        });

        function showResults(score, percentage) {
            const correctCount = quizQuestions.filter(q => userAnswers[q.id] === q.correct).length;
            const incorrectCount = quizQuestions.length - correctCount;
            
            let gradeClass = 'grade-good';
            if (percentage >= 90) {
                gradeClass = 'grade-excellent';
                createConfetti();
            } else if (percentage >= 75) {
                gradeClass = 'grade-good';
                createConfetti();
            } else if (percentage >= 60) {
                gradeClass = 'grade-good';
            } else if (percentage >= 50) {
                gradeClass = 'grade-fair';
            } else {
                gradeClass = 'grade-poor';
            }
            
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = `
                <div class="results-card">
                    <div class="grade-display ${gradeClass}">${percentage}%</div>
                    <p style="color: var(--text-primary); font-size: 1.5rem; margin-top: 20px;">Poprawne: ${correctCount}/20</p>
                    <p style="color: var(--text-secondary); font-size: 1.2rem; margin-top: 10px;">BÅ‚Ä™dne: ${incorrectCount}/20</p>
                    <p style="color: var(--text-primary); font-size: 1.3rem; margin-top: 15px;">TwÃ³j wynik: ${score}/20 (${percentage}%)</p>
                </div>
            `;
            
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function createConfetti() {
            // read theme-aware colors from CSS variables so visuals follow HSL vars
            const style = getComputedStyle(document.documentElement || document.body);
            const colors = [
                style.getPropertyValue('--primary-cyan').trim() || '#06B6D4',
                style.getPropertyValue('--secondary-blue').trim() || '#0EA5E9',
                style.getPropertyValue('--accent-cyan').trim() || '#38BDF8',
                style.getPropertyValue('--success').trim() || '#10B981',
                style.getPropertyValue('--warning').trim() || '#F59E0B'
            ];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Navigation state persists in memory during session
        // Note: localStorage unavailable in sandboxed environment, using in-memory storage
    </script>
</body>
</html>